<!DOCTYPE html>
<head>
  <title>AP Ticket</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
  <meta name="description" content="Formal Afterparty Ticket" />
  <link rel="stylesheet" href="../styles.css" />
  <link rel="icon" type="image/png" href="favicon.png" />
  <link rel="stylesheet" href="./reader.css" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <meta name="msapplication-TileColor" content="#34a0a4" />
  <meta name="theme-color" content="#ffffff" />
</head>
<body>
  <div id="frameContainer">
    <div class="autoheight" id="frame">
      <div class="top">
        <h1>Ticket Scanner</h1>
        <br />
        <div id="topseperator" class="seperator top">
          <div class="line leftline"></div>
          <div class="btext"><p>Scanner</p></div>
          <div class="line rightline"></div>
        </div>
        <div id="qrcodediv">
          <div style="width: 500px" id="reader"></div>
        </div>
        <h1 id="name"></h1>
        <div id="findmyticket">
          <br />
          <button class="payment" onclick="window.location.href = '../alreadypaid/'"><span class="text">Find My Ticket</span></button>
        </div>
      </div>
    </div>
  </div>
  <script src="html5-qrcode.min.js"></script>
  <script type="text/javascript">
    let password;
let lastInput;

// Function to prompt for password on page load
window.onload = function() {
    password = prompt("Enter the password:");
}

// Function to scan ID and display result
function scan(id) {
    // Check if password is set
    if (!password) {
        alert("Please enter the password first.");
        return;
    }

    // Check if ID is different from last input
    if (id !== lastInput) {
        // Make AJAX call to server with password and id
        fetch('https://aptapi.joshnewman6.com/apt/checkTicket', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: id, password: password })
        })
        .then(response => response.json())
        .then(data => {
            if (data.name) {
                displaySuccess(data.name);
            } else {
                displayFailure();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayFailure();
        });

        lastInput = id;
    }
}

// Function to display success
function displaySuccess(name) {
    const tickElement = document.getElementById('tick');
    tickElement.classList.add('success');
    tickElement.innerText = '✓';

    const nameElement = document.getElementById('name');
    nameElement.innerText = `Scanned Name: ${name}`;

    // Remove tick after 3 seconds (3000 milliseconds)
    setTimeout(() => {
        tickElement.remove();
        nameElement.innerText = '';
    }, 1000);
}

// Function to display failure
function displayFailure() {
    const tickElement = document.getElementById('tick');
    tickElement.classList.add('failure');
    tickElement.innerText = '✕';

    const nameElement = document.getElementById('name');
    nameElement.innerText = '';

    // Remove cross after 3 seconds (3000 milliseconds)
    setTimeout(() => {
        tickElement.remove();
    }, 1000);
}

    function onScanSuccess(decodedText, decodedResult) {
    // Handle on success condition with the decoded text or result.
    console.log(`Scan result: ${decodedText}`, decodedResult);
    }

    var html5QrcodeScanner = new Html5QrcodeScanner(
    	"reader", { fps: 20, qrbox: 250 });
    html5QrcodeScanner.render(onScanSuccess);
  </script>
</body>
